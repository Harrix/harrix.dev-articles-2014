---
date: 2014-04-09
categories: [it, photo]
tags: [Time-lapse, Adobe After Effects, VirtualDub, Deflicker]
related-id: time-lapse
update: 2018
---

# Как сделать Time-lapse видео. Часть 4 — Сложная, но качественная сборка видео

Во третей части обсудим как собрать видео из фотографий в Adobe After Effects CS6.

Решил написать серию статей о том, как собрать нормальное Time-lapse видео для новичков. В интернете мало материала, которые бы показывали, как собрать видео не с профессиональной техникой, как исправлять проблемные моменты… Я сам непрофессионал в данной области, так что можно считать, что эти статьи написаны для памятки себе.

Вот, что мы получим в итоге:

<https://www.youtube.com/watch?v=9Ta4LNR_6AI>

**Что потребуется**: снимки, After Effects, VirtualDub, Xilisoft Video Converter Ultimate.

## Создание проекта

Откроем наш After Effects. Я показываю на примере After Effects CS6:

![Создание проекта в After Effects](img/after-effects_01.png)

Создадим проект в режиме FULL-HD с 24 кадрами в секунду:

![Выбор шаблона видео](img/after-effects_02.png)

Получим вот такой монтажный стол:

![Основное окно After Effects](img/after-effects_03.png)

Добавим наши изображения к проекту через `File` → `Import` → `Multiple Files…`:

![Вызов команды импорта изображений](img/after-effects_04.png)

При этом выбираем только первую фотографию! Остальные выделять не надо. Программа сама добавит все рисунки из этой папки. Поэтому будьте осторожны и следите, чтобы в папке были только нужные вам файлы:

![Выбор одной фотографии из папки](img/after-effects_05.png)

После нажатия на `OK` вам предложат добавить еще файлы, но вы откажитесь:

![Отказа от добавления других файлов](img/after-effects_06.png)

И в списке файлов и объектов проекта появится сборник всех фотографий, где фотографии уже расположены в правильном порядке и с правильной длительностью:

![Объект со всеми фотографиями из папки](img/after-effects_07.png)

Теперь смотрите. Основной монтажный стол у нас для видео 1920 × 1080 px. А фотографии у нас куда большего размера. Если мы перетащим фотографии сразу в основное видео и там обработаем, то потом не сможем приближать и удалять кадры и так далее. Поэтому обработаем фотографии на монтажном столе такого же размера, что и размер фотографий. Для этого щелкаем правой кнопкой по объекту фотографий и идем в `New Comp from Selection`:

![Создание новой Sequence](img/after-effects_08.png)

Получили новый Sequence:

![Новая Sequence в списке ресурсов](img/after-effects_09.png)

Двойной щелчок и мы перешли на монтажный стол этого Sequence:

![Второй монтажный стол](img/after-effects_10.png)

Проект мы создали. Теперь займемся стабилизацией видео, так как камера в данном случае сильно дрожала на ветру, и итоговое видео колбасит.

## Стабилизация видео

Откройте вкладку `Window` → `Tracker`:

![Открытие окна Tracker](img/after-effects_11.png)

И в этой панели вызываем команду `Warp Stabilizer`. Данный метод мне помог, но если вам не помогает, то попробуйте другие из данного набора:

![Выбор Warp Stabilizer](img/after-effects_12.png)

После нажатия на кнопку начнется долгий процесс:

![Процесс стабилизации](img/after-effects_13.png)

В итоге наше видео стабилизируется.

## Удаление шумов (птиц и насекомых)

В процессе съемок в кадр могут попадать шумы: случайно залетевшие насекомые, птицы, которые попадают на один кадр, а потом улетают. В итоге получается видео с шумами, как в старом кино. Что делать? Предлагается такая идея (не моя): вставить на видео такое же видео над ним, но смещенное на один кадр, и режим смешивания будет поставлено на Lighten. Что это даст? Два соседних кадра не сильно отличаются друг от друга, и при наложении если и создаться небольшое «мыло», то повышением резкости можно убрать это мыло. А вот насекомые и птицы обычно в виде черных пятен выступают. Так как они от кадра к кадру перемещаются, то режимом смешивания они и уберутся. Но есть недостаток в случае, если у нас в кадре есть близко лежащие объекты, которые динамически двигаются. У меня, например, это трава на переднем плане. И при использовании метода получается раздвоение этой травы. Поэтому наложим маску или разукрасим верхнее видео в тех областях, в которых наложение нам не нужно. Надеюсь, понятно объяснил. Эффект раздвоения травы:

![Эффект раздвоения травы](img/after-effects_14.png)

Для этого создадим еще один Sequence на основе существующего:

![Создание новой Sequence](img/after-effects_15.png)

И переименуем его в `Without Noise`:

![Переименование Sequence](img/after-effects_16.png)

![Новое имя Sequence](img/after-effects_17.png)

Перейдем в `Without Noise`. И перетащим еще один Sequence с фотографиями:

![Добавление объекта с фотографиями](img/after-effects_18.png)

Верхний слой перетащим на один фрейм вправо:

![Перетаскивание одного слоя на один фрейм](img/after-effects_19.png)

Добавим маску для верхнего слоя:

![Создание новой маски](img/after-effects_20.png)

Откроем нашу маску у слоя:

![Открытие маски слоя](img/after-effects_21.png)

Щелкнем по маске двойным щелчком. И увидим следующее:

![Открытая маска слоя](img/after-effects_22.png)

Берем кисточку и выбираем черный цвет:

![Выбор инструмента для работы с маской](img/after-effects_23.png)

И закрашиваем ту область, которую мы не хотим потом обрабатывать в дальнейшем:

![Закрашивание области с близкими объектами](img/after-effects_24.png)

Переходим в обычное окно просмотра видео:

![Переход в стандартный просмотр видео](img/after-effects_25.png)

Переходим к выбору типа смешивания слоя:

![Режим смешивания слоя](img/after-effects_26.png)

У меняем на `Lighten`:

![Изменение режима смешивания на Lighten](img/after-effects_27.png)

Посмотрите на пример. Вот тут видим размытое пятно какого-то насекомого:

![Кадр с пятном от насекомого не в фокусе](img/after-effects_28.png)

А с нашим способом оно исчезло:

![Пятно от насекомого исчезло](img/after-effects_29.png)

## Эффект движения камеры и финальное редактирование в After Effects

На данный момент имеем такую картину:

![Текущее состояние редактора видео](img/after-effects_30.png)

Кстати, масштаб просмотра видео можно менять на тот, что вам нужен:

![Изменение масштаба в плеере просмотра видео](img/after-effects_31.png)

На основе предыдущего Sequence создадим еще одну и переименуем в `Finish Source`:

![Создание новой Sequence](img/after-effects_32.png)

![Новая Sequence](img/after-effects_33.png)

Это мы сделали для удобства, чтобы не таскаться с двумя сдвинутыми слоями и маской. Теперь перейдем в наш самый первоначальный монтажный стол (у меня `Comp 1`) и перетащим туда наш последний Sequence:

![Перетаскивание Sequence в главный монтажный стол](img/after-effects_34.png)

Уменьшите размер слоя в окне просмотра видео. Так как я хочу сделать еще эффект движения, то не полностью вписываю слой под размер экрана:

![Размер объекта с фотографиями специально больше кадра](img/after-effects_35.png)

Теперь перейдем к настройкам нашего слоя на монтажном слое:

![Настройки слоя](img/after-effects_36.png)

Убедитесь, что каретка помещена в начало ролика. После этого щелкните по изображениям часиков около `Position` и `Scale`. Тем самым мы создадим ключевой кадр, где эти параметры будут фиксированы:

![Создание ключевого кадра](img/after-effects_37.png)

Переместите каретку на последний кадр:

![Перемещение каретки на последний кадр](img/after-effects_38.png)

Сдвиньте и измените масштаб слоя в окне просмотра видео. При этом будет создан второй ключевой кадр:

![Изменение размера фотографий и их положения](img/after-effects_39.png)

Всё! Обработку в After Effects мы закончили. Теперь запустим генерацию видео. Перейдем в меню экспорта:

![Выбор пункта экспорта видео](img/after-effects_40.png)

Устанавливаем настройки по максимуму и запускаем `Render`:

![Настройки экспортируемого видео](img/after-effects_41.png)

И начнется процесс рендеринга:

![Процесс рендеринга](img/after-effects_42.png)

В итоге получим наш видеофайл:

![Сгенерированный файл](img/after-effects_43.png)

## Убирание мерцания

Видео мы получили. Дрожание камеры убрали. Насекомых убрали. Красивое плавное движение камеры добавили. Но осталось мерцание видео, так как снимки снимались в автоматическом режиме. Надо убрать. В After Effects я не нашел штатных средств для решения задачи. Вроде есть плагины, но они платные и так их не нашел по-быстрому. Для решения будем использовать бесплатную программу <http://www.virtualdub.org/download.html>.

В папку плагинов `plugins32` надо закинуть плагин `MSU Deflicker v1.3`.

Этот плагин можно тут взять: [msu_deflick.zip](files/msu_deflick.zip).

А можно всю сборку сразу скачать: [VirtualDub-1.10.4.zip](files/VirtualDub-1.10.4.zip).

Запускаем главный EXE файл:

![Запуск VirtualDub](img/virtualdub_01.png)

Не открывая видео, заходим в фильтры:

![Переход в окно фильтров](img/virtualdub_02.png)

Жмем кнопку добавления фильтра:

![Добавление нового фильтра](img/virtualdub_03.png)

Добавляем наш фильтр `MSU Deflicker v1.3`:

![Добавление фильтра MSU Deflicker](img/virtualdub_04.png)

Параметры по умолчанию оставляем:

![Выбор параметров фильтра](img/virtualdub_05.png)

Жмем `OK`:

![Нажатие на кнопку OK](img/virtualdub_06.png)

Теперь открываем видеофайл:

![Открытие видеофайла](img/virtualdub_07.png)

Открыли:

![Загруженный видеофайл](img/virtualdub_08.png)

И сразу сохраняем в AVI формате:

![Сохранение файла с примененным фильтром](img/virtualdub_09.png)

В результате начнется преобразование, чтобы убрать мерцание картинки:

![Процесс преобразования](img/virtualdub_10.png)

Получим в итоге новый видео файл. Фактически это итоговый конечный файл, который можно уже использовать где надо: загружать на сайты, редактировать и так далее:

![Файл видео без мерцаний](img/virtualdub_11.png)

## Сжатие файла

Эта часть не обязательная. И его можно сделать многими способами. У нас есть большой видеофайл в 10 секунд размером больше 1 Гб. Многовато. Надо сжать. Будем сжимать программой Xilisoft Video Converter Ultimate:

![Окно загрузки программы](img/converter_01.png)

Зададим такие настройки:

![Выбор настроек конвертации](img/converter_02.png)

И запускаем преобразование:

![Запуск конвертации](img/converter_03.png)

![Процесс конвертации](img/converter_04.png)

В итоге получили видео, как в начале статьи.

Вроде получилось неплохо. Конечно, можно был поработать над резкостью и так далее, но это вы уже сможете сделать сами.

**Update 2018.** Сейчас я бы вместо Xilisoft Video Converter Ultimate воспользовался Adobe Premiere.

У меня в итоге получилось вот такое видео:

<https://www.youtube.com/watch?v=g0XnvLhvHN4>
